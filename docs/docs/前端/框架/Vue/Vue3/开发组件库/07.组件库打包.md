# ç»„ä»¶åº“æ‰“åŒ…

:::tip

ä½œè€…ï¼šoutsider_å‹äººA

é“¾æ¥ï¼š[ç¨€åœŸæ˜é‡‘](https://juejin.cn/post/7452529073208197174)

:::



æœ€è¿‘æœ‰å¾ˆå¤šå°ä¼™ä¼´è®©æˆ‘èµ¶ç´§å‡ºæ‰“åŒ…æ•™ç¨‹ï¼Œé‚£å°±æˆ‘ä»¬å…ˆæ‰“åŒ…ï¼Œä¹…ç­‰äº†ğŸ‘‹

### Rollup æ‰“åŒ…

Rollup æ˜¯ä¸€ä¸ª JavaScript æ¨¡å—æ‰“åŒ…å™¨ï¼Œå¯ä»¥å°†å¤šä¸ªæ¨¡å—æ‰“åŒ…æˆä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶ã€‚å®ƒæ”¯æŒå¤šç§æ¨¡å—åŒ–æ ‡å‡†ï¼Œå¦‚ CommonJSã€ESM ç­‰ï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨ç§»é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œä»è€Œå‡å°æ‰“åŒ…æ–‡ä»¶çš„å¤§å°ã€‚

#### é€‰æ‹© Rollup æ‰“åŒ…çš„ä¼˜åŠ¿:

- `Tree-shaking` Rollup å¯ä»¥è‡ªåŠ¨ç§»é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‡å°‘äº†æ‰“åŒ…æ–‡ä»¶çš„å¤§å°ï¼Œæé«˜äº†åº”ç”¨çš„åŠ è½½é€Ÿåº¦ã€‚
- `æ¨¡å—åŒ–æ”¯æŒ` Rollup æ”¯æŒå„ç§æ¨¡å—åŒ–ä»£ç ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç† ESMã€‚
- `æ’ä»¶ä¸°å¯Œ` Rollup çš„æ’ä»¶ç³»ç»Ÿéå¸¸å¼ºå¤§ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡å®‰è£…å„ç§æ’ä»¶æ¥å®ç°ä¸åŒçš„æ‰“åŒ…éœ€æ±‚ã€‚
- `é…ç½®çµæ´»` Rollup çš„é…ç½®æ–‡ä»¶å¯ä»¥å®ç°éå¸¸çµæ´»çš„æ‰“åŒ…è§„åˆ™ï¼Œå¼€å‘è€…å¯ä»¥æ ¹æ®åº”ç”¨éœ€æ±‚è°ƒæ•´é…ç½®ï¼Œæ»¡è¶³ä¸ªæ€§åŒ–éœ€æ±‚ã€‚
- `ä¼˜åŒ–æ€§èƒ½` Rollup å¯ä»¥é«˜æ•ˆåœ°å¤„ç†æ¨¡å—ä¾èµ–å…³ç³»ï¼Œå‡å°‘é‡å¤ä»£ç çš„åŠ è½½ï¼Œæé«˜åº”ç”¨çš„æ‰§è¡Œæ•ˆç‡ã€‚

#### å®‰è£…

```bash
pnpm install -D rollup @rollup/plugin-node-resolve rollup-plugin-vue -w
```

#### Vue æ‰“åŒ…é…ç½®

æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª rollup.config.js æ–‡ä»¶ï¼Œæˆ‘ä»¬å…ˆæ‰“åŒ…ä¸ºæˆ‘ä»¬æœ€å¸¸ç”¨çš„ es æ¨¡å—ï¼Œé…ç½®å¦‚ä¸‹ï¼š

```js
import resolve from "@rollup/plugin-node-resolve";
import vuePlugin from "rollup-plugin-vue";

export default {
  input: "./packages/components/index.js",
  output: {
    file: "dist/es.js",
    name: "TestUI",
    format: "es",
  },
  plugins: [resolve(), vuePlugin()],
  external: ["vue"], // ä¾èµ–æ¨¡å—
};
```

ç„¶åæˆ‘ä»¬éœ€è¦é…ç½®æ‰“åŒ…å‘½ä»¤ `"build": "rollup -c"`

package.json

```json
{
  "name": "test-ui",
  "version": "1.0.0",
  "description": "",
  "scripts": {
    "dev": "vite examples",
    "test": "echo \"Error: no test specified\" && exit 1",
    "docs:dev": "vitepress dev docs",
    "docs:build": "vitepress build docs",
    "docs:preview": "vitepress preview docs",
    "build": "rollup -c"
  }
}
```

æˆ‘ä»¬æ‰§è¡Œä¸€ä¸‹ `npm run build`ï¼Œç»“æœæŠ¥é”™äº†

![image-20250715171344204](https://gitee.com/xarzhi/picture/raw/master/img/image-20250715171344204.png)

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ä½¿ç”¨çš„ ES module å†™æ³•ï¼Œæˆ‘ä»¬éœ€è¦å°† `package.json` ä¸­çš„ `type` æ”¹ä¸º `module`

è¿™æ—¶å€™å†æ¥è¯•ä¸€ä¸‹ï¼ŒæˆåŠŸäº†

![image-20250715171357261](https://gitee.com/xarzhi/picture/raw/master/img/image-20250715171357261.png)

ç”±äºæˆ‘ä»¬æ‰“åŒ…çš„æ˜¯ es æ¨¡å—ï¼Œæ‰€æœ‰å¯ä»¥ç›´æ¥åœ¨æˆ‘ä»¬çš„ examples é¡¹ç›®ä¸­å¼•å…¥ä¸€ä¸‹æˆ‘ä»¬åˆšæ‰æ‰“åŒ…çš„æ–‡ä»¶ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨

**å¦‚é‡åˆ°scsså¾ªç¯æŠ¥é”™ï¼Œå¯å°†scsså•ç‹¬å†™æˆä¸€ä¸ªæ–‡ä»¶ï¼Œä¸è¦å†™åœ¨vueæ–‡ä»¶é‡Œ**

examples/index.js

```js
import { createApp } from "vue";
import App from "./app.vue";
// import TestUI from '@test-ui/components'
// import "@test-ui/theme-chalk/index.less"; // å¼•å…¥æ ·å¼æ–‡ä»¶
import TestUI from "../dist/es.js";

const app = createApp(App);
app.use(TestUI);
app.mount("#app");
```

![image-20250715171409569](https://gitee.com/xarzhi/picture/raw/master/img/image-20250715171409569.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯æ­£å¸¸çš„ï¼Œåªæ˜¯æ²¡æœ‰æ ·å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬é…ç½®ä¸€ä¸‹æ ·å¼æ–‡ä»¶æ‰“åŒ…

#### é…ç½®æ ·å¼æ–‡ä»¶æ‰“åŒ…

æˆ‘ä»¬ä¼šç”¨åˆ°ä¸€äº›æ’ä»¶ï¼Œæ¥å®‰è£…ä¸€ä¸‹

```bash
pnpm i rollup-plugin-postcss autoprefixer -D -w
```

ä½¿ç”¨æ’ä»¶é…ç½®ä¸€ä¸‹

```js
import resolve from "@rollup/plugin-node-resolve";
import vuePlugin from "rollup-plugin-vue";
import postcss from "rollup-plugin-postcss";
import autoprefixer from "autoprefixer";

export default {
  input: "./packages/components/index.js",
  output: {
    file: "dist/es.js",
    name: "TestUI",
    format: "es",
  },
  plugins: [
    resolve(),
    vuePlugin(),
    postcss({
      extract: "theme-chalk/style.css", // å°†cssæå–åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­
      plugins: [autoprefixer()],
    }),
  ],
  external: ["vue"], // ä¾èµ–æ¨¡å—
};
```

å› ä¸ºæˆ‘ä»¬éœ€è¦ä½¿ç”¨ postcss æ¥æŠ½ç¦»æˆ‘ä»¬ js ä¸­æ‰€å¼•å…¥çš„æ ·å¼æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬çš„ç»„ä»¶åº“ä¸­å¼•å…¥æ ·å¼æ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ `extract` æŠ½ç¦»æ‰“åŒ…åˆ° `dist/theme-chalk/style.css` ä¸­

packages/components/index.js

```js
import * as components from "./components";
import "@test-ui/theme-chalk/index.less";

const FUNCTION_COMP = ["TMessage"];

export default {
  install(app) {
    Object.entries(components).forEach(([key, value]) => {
      if (!FUNCTION_COMP.includes(key)) app.component(key, value);
    });
  },
};

export const TMessage = components.TMessage;
```

æˆ‘ä»¬æ‰“åŒ…ä¸€ä¸‹è¯•è¯•

![image-20250715171425047](https://gitee.com/xarzhi/picture/raw/master/img/image-20250715171425047.png)

å‘ç°æ ·å¼ç¡®å®å·²ç»æ‰“åŒ…æˆåŠŸï¼Œä½†æ˜¯æˆ‘ä»¬çš„ font æ–‡ä»¶å¹¶æ²¡æœ‰ä¸€å¹¶æ‰“åŒ…å‡ºæ¥ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦å°† font æ–‡ä»¶æ‹·è´å‡ºæ¥ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°ä¸€ä¸ªæ’ä»¶ `rollup-plugin-copy`

```bash
pnpm i rollup-plugin-copy -D -w
```

å†æ¥æ·»åŠ ä¸€ä¸‹é…ç½®ï¼Œæˆ‘ä»¬å°† `packages/theme-chalk/fonts/` è·¯å¾„ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æ‹·è´åˆ° `dist/theme-chalk/fonts/` ä¸‹

```js
import resolve from "@rollup/plugin-node-resolve";
import vuePlugin from "rollup-plugin-vue";
import postcss from "rollup-plugin-postcss";
import autoprefixer from "autoprefixer";
import copy from "rollup-plugin-copy";

export default {
  input: "./packages/components/index.js",
  output: {
    file: "dist/es.js",
    name: "TestUI",
    format: "es",
  },
  plugins: [
    resolve(),
    vuePlugin(),
    postcss({
      extract: "theme-chalk/style.css", // å°†cssæå–åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­
      plugins: [autoprefixer()],
    }),
    copy({
      targets: [{ src: "packages/theme-chalk/fonts/*", dest: "dist/theme-chalk/fonts/" }],
    }),
  ],
  external: ["vue"], // ä¾èµ–æ¨¡å—
};
```

å†æ‰“åŒ…ä¸€ä¸‹çœ‹çœ‹

![image-20250715171440009](https://gitee.com/xarzhi/picture/raw/master/img/image-20250715171440009.png)

font æ–‡ä»¶é¡ºåˆ©æ‹·è´å‡ºæ¥äº†ï¼Œä½†æ˜¯è·¯å¾„ä¸å¯¹ï¼Œæˆ‘ä»¬æ€»ä¸èƒ½æ¯æ¬¡æ‰“åŒ…å®Œæˆåæ‰‹åŠ¨ä¿®æ”¹è·¯å¾„ï¼Œè¿™æ—¶å€™æˆ‘ä»¬åˆéœ€è¦ä½¿ç”¨ä¸€ä¸ªæ’ä»¶ `postcss-url`

```bash
pnpm i postcss-url -D -w


import resolve from "@rollup/plugin-node-resolve";
import vuePlugin from "rollup-plugin-vue";
import postcss from "rollup-plugin-postcss";
import autoprefixer from "autoprefixer";
import copy from "rollup-plugin-copy";
import url from "postcss-url";

export default {
  input: "./packages/components/index.js",
  output: {
    file: "dist/es.js",
    name: "TestUI",
    format: "es",
  },
  plugins: [
    resolve(),
    vuePlugin(),
    postcss({
      extract: "theme-chalk/style.css", // å°†cssæå–åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­
      plugins: [
        autoprefixer(),
        url({
          url: "copy",
          basePath: "fonts",
          assetsPath: "fonts",
        }),
      ],
    }),
    copy({
      targets: [{ src: "packages/theme-chalk/fonts/*", dest: "dist/theme-chalk/fonts/" }],
    }),
  ],
  external: ["vue"], // ä¾èµ–æ¨¡å—
};
```

å†æ¥è¯•è¯•ï¼Œå‘ç°è·¯å¾„å·²ç»æ­£ç¡®äº†

![image-20250715171452336](https://gitee.com/xarzhi/picture/raw/master/img/image-20250715171452336.png)

æˆ‘ä»¬å†å¯åŠ¨ä¸€ä¸‹ examples é¡¹ç›®çœ‹çœ‹æ ·å¼æ˜¯å¦æ­£å¸¸

![image-20250715171507906](https://gitee.com/xarzhi/picture/raw/master/img/image-20250715171507906.png)

ä¸¸ç¾ï¼

âœ¨ æ‹“å±•ä¸€ä¸‹ï¼Œ`postcss-url` ä¹Ÿå¯ä»¥é…ç½® `url` å±æ€§ä¸º `inline`ï¼Œè¿™æ ·å°±å¯ä»¥å°†å­—ä½“æ–‡ä»¶ç›´æ¥å†…è”åˆ° css æ–‡ä»¶ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ç”¨æ‹·è´ font æ–‡ä»¶äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ”¹ä¸€ä¸‹ç„¶åæ‰“åŒ…è¯•è¯•

```js
import resolve from "@rollup/plugin-node-resolve";
import vuePlugin from "rollup-plugin-vue";
import postcss from "rollup-plugin-postcss";
import autoprefixer from "autoprefixer";
import copy from "rollup-plugin-copy";
import url from "postcss-url";

export default {
  input: "./packages/components/index.js",
  output: {
    file: "dist/es.js",
    name: "TestUI",
    format: "es",
  },
  plugins: [
    resolve(),
    vuePlugin(),
    postcss({
      extract: "theme-chalk/style.css", // å°†cssæå–åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­
      plugins: [
        autoprefixer(),
        url({
          url: "inline",
          basePath: "fonts",
          assetsPath: "fonts",
        }),
      ],
    }),
    // copy({
    //   targets: [
    //     { src: 'packages/theme-chalk/fonts/*', dest: 'dist/theme-chalk/fonts/' }
    //   ]
    // })
  ],
  external: ["vue"], // ä¾èµ–æ¨¡å—
};
```

æ‰“åŒ…ä¹‹åæˆ‘ä»¬ç‚¹å¼€æ ·å¼æ–‡ä»¶çœ‹çœ‹ï¼Œä»–ä¼šè½¬ä¸º base64 ç¼–ç ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å³ä½¿ä¸ç”¨æ‹·è´ font æ–‡ä»¶ä¹Ÿå°±å¯ä»¥ä½¿ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¿è¡Œä¸€ä¸‹çœ‹çœ‹ä¹Ÿæ˜¯æ­£å¸¸æ˜¾ç¤ºçš„

![project-20241226-8.png](https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f12bb062fd3d43e4a5ce024b9530373c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3V0c2lkZXJf5Y-L5Lq6QQ==:q75.awebp?rk3s=f64ab15b&x-expires=1752571835&x-signature=NokvX4XKHOt4Fzrw0M%2BoKAc7OXQ%3D)

ä¸è¿‡è¿˜æ˜¯å»ºè®®å°† font åˆ†å‡ºæ¥ï¼Œå› ä¸ºè¿™ä¼šé€ æˆ css æ–‡ä»¶è¿‡å¤§ï¼Œæµè§ˆå™¨åŠ è½½æ—¶é—´å°±ä¼šå˜é•¿ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ

#### æ‰“åŒ…ä¸ºå…¶ä»–æ ¼å¼

æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰“åŒ…ä¸ºå…¶ä»–æ ¼å¼ï¼Œæ¯”å¦‚ cjsï¼Œumd ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `rollup.config.js` ä¸­é…ç½®ä¸€ä¸‹

```js
import resolve from "@rollup/plugin-node-resolve";
import vuePlugin from "rollup-plugin-vue";
import postcss from "rollup-plugin-postcss";
import autoprefixer from "autoprefixer";
import copy from "rollup-plugin-copy";
import url from "postcss-url";

export default {
  input: "./packages/components/index.js",
  output: [
    {
      file: "dist/es.js",
      name: "TestUI",
      format: "es",
    },
    {
      file: "dist/cjs.js",
      name: "TestUI",
      format: "cjs",
      exports: "named",
    },
    {
      file: "dist/umd.js",
      name: "TestUI",
      format: "umd",
      exports: "named",
      globals: {
        vue: "Vue",
      },
    },
  ],
  plugins: [
    resolve(),
    vuePlugin(),
    postcss({
      extract: "theme-chalk/style.css", // å°†cssæå–åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­
      plugins: [
        autoprefixer(),
        url({
          url: "copy",
          basePath: "fonts",
          assetsPath: "fonts",
        }),
      ],
    }),
    copy({
      targets: [{ src: "packages/theme-chalk/fonts/*", dest: "dist/theme-chalk/fonts/" }],
    }),
  ],
  external: ["vue"], // ä¾èµ–æ¨¡å—
};
```

![image-20250715171517354](https://gitee.com/xarzhi/picture/raw/master/img/image-20250715171517354.png)

## Vite æ‰“åŒ…

ç”±äºæˆ‘ä»¬åœ¨ examples ä¸­ä½¿ç”¨äº† viteï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ vite æ¥æ‰“åŒ…ï¼Œæˆ‘ä»¬åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª build æ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«åˆ›å»ºä¸€ä¸ª `vite.es.config.js` `vite.umd.config.js`ï¼Œåˆ†æ¥ä»£è¡¨ es çš„é…ç½®å’Œ umd çš„é…ç½®

/build/vite.es.config.js

```js
// ç»„ä»¶åº“æ‰“åŒ…é…ç½®
import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";
import path from "path";

export default defineConfig({
  plugins: [vue()],
  build: {
    outDir: "dist/es",
    lib: {
      entry: path.resolve(__dirname, "../packages/components/index.js"),
      name: "TestUI",
      fileName: "index",
      formats: ["es"],
    },
    rollupOptions: {
      external: ["vue"],
      output: {
        exports: "named",
        globals: {
          vue: "Vue",
        },
      },
    },
  },
});
```

/build/vite.umd.config.js

```js
js ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";
import path from "path";

export default defineConfig({
  plugins: [vue()],
  build: {
    outDir: "dist/umd",
    lib: {
      entry: path.resolve(__dirname, "../packages/components/index.js"),
      name: "TestUI",
      fileName: "index",
      formats: ["umd"],
    },
    rollupOptions: {
      external: ["vue"],
      output: {
        exports: "named",
        globals: {
          vue: "Vue",
        },
        assetFileNames: (assetInfo) => {
          if (assetInfo.name === "index.css") {
            return "style.css";
          }
          return assetInfo.name;
        },
      },
    },
  },
});
```

æˆ‘ä»¬æ·»åŠ ä¸€ä¸‹æ‰“åŒ…å‘½ä»¤

```json
json ä½“éªŒAIä»£ç åŠ©æ‰‹ ä»£ç è§£è¯»å¤åˆ¶ä»£ç {
  "name": "test-ui",
  "version": "1.0.0",
  "description": "",
  "type": "module",
  "scripts": {
    "dev": "vite examples",
    "test": "echo \"Error: no test specified\" && exit 1",
    "docs:dev": "vitepress dev docs",
    "docs:build": "vitepress build docs",
    "docs:preview": "vitepress preview docs",
    "build": "rollup -c",
    "build:es": "vite build --config ./build/vite.es.config.js",
    "build:umd": "vite build --config ./build/vite.umd.config.js"
  }
}
```

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ `pnpm run build:es` å’Œ `pnpm run build:umd` æ¥æ‰“åŒ… es å’Œ umd æ ¼å¼çš„ç»„ä»¶åº“äº†



